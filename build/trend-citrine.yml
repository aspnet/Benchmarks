# Executes the Proxy benchmarks on citrine

# Agent-less jobs need this pool
pool: server


variables:
  session: "$[format('{0:yyyyMMddHHmm}', pipeline.startTime)]"
  plaintextJobs: -j https://raw.githubusercontent.com/aspnet/Benchmarks/master/src/Benchmarks/benchmarks.plaintext.json
  defaultArgs: --server $(server) --client $(client) --runtimeversion 5.0.* --self-contained --warmup 5 --duration 5 --collect-counters --description Trend/Latest
  sqlArgs: --table \"BENCHMARKS_CONNECTION_STRING\"
  scenarios: 
  - displayName: "Plaintext"
    args: "-n Plaintext $(plaintextJobs) $(defaultArgs) $(sqlArgs)"
  - displayName: "Plaintext non pipelined"
    args: "-n PlaintextNonPipelined $(plaintextJobs) $(defaultArgs) $(sqlArgs)"


# all the jobs are triggered at the same time
# jobs are in parallel
# steps are serial

jobs:
- job: Trends
  steps:
  - ${{ each s in variables.scenarios }}:
    - task: PublishToAzureServiceBus@1
      displayName: ${{ s.displayName }}
      condition: always()
      inputs:
        azureSubscription: ASP.NET Benchmarks Queue
        waitForCompletion: true
        messageBody: |
          {
            "name": "benchmarksdriver",
            "args": [ "${{ s.args }}" ]
          }
