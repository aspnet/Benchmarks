# SignalR scenarios

parameters:
- name: server
  type: string
  default: ''
- name: client
  type: string
  default: ''
- name: warmup
  type: number
  default: 0
- name: duration
  type: number
  default: 15
- name: connection
  type: string
  default: ''

# Scenarios
- name: scenarios 
  type: object
  default: 

  - displayName: Broadcast
    arguments: --scenario broadcast $(signalRJobs)
  - displayName: Echo
    arguments: --scenario echo $(signalRJobs)
  - displayName: Echo All
    arguments: --scenario echoAll $(signalRJobs)

# Transports
- name: transports 
  type: object
  default: 

  - displayName: WebSockets
    arguments: --load.variable.transport WebSockets
  - displayName: ServerSentEvents
    arguments: --load.variable.transport ServerSentEvents
  - displayName: LongPolling
    arguments: --load.variable.transport LongPolling

# Protocols
- name: protocols
  type: object
  default: 

  - displayName: Json
    arguments: --load.variable.protocol json
  - displayName: MessagePack
    arguments: --load.variable.protocol messagepack

steps:
- ${{ each s in parameters.scenarios }}:
  - ${{ each transport in parameters.transports }}:
    - ${{ each protocol in parameters.protocols }}:
      - task: PublishToAzureServiceBus@1
        condition: succeededOrFailed()
        enabled: ${{ not( and( eq(transport.displayName, 'ServerSentEvents'), eq(protocol.displayName, 'MessagePack'))) }}
        displayName: ${{ s.displayName }} ${{ transport.displayName }} ${{ protocol.displayName }}
        inputs:
          connectedServiceName: ${{ parameters.connection }}
          waitForCompletion: true
          messageBody: |
            {
              "name": "benchmarksdriver2",
              "args": [ "${{ s.arguments }} ${{ transport.arguments }} ${{ protocol.arguments }} --application.collectCounters true --load.collectCounters true --load.variables.warmup ${{ parameters.warmup }} --load.variables.duration ${{ parameters.duration }} --application.endpoints ${{ parameters.server }} --load.endpoints ${{ parameters.client }} --load.runtimeversion 5.0.* --application.runtimeversion 5.0.* --session $(session) --table SignalRBenchmarks " ]
            }
          #--sql SQL_CONNECTION_STRING

