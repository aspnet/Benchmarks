# Container Matrix scenarios

parameters:
- name: server # the url of the agent service, e.g. http://asp-perf-lin:5001
  type: string
  default: ''
- name: connection
  type: string
  default: ''
- name: profile
  type: string
  default: ''

# Sizes
- name: sizes
  type: object
  default:

    - displayName: Mini
      cpu: 0.25
      memory: 40mb
    - displayName: Small
      cpu: 1
      memory: 100mb
    - displayName: Medium
      cpu: 2
      memory: 250mb
    - displayName: Large
      cpu: 4
      memory: 500mb
    - displayName: QuarterMachine
      cpu: 7
      memory: 8gb
    - displayName: HalfMachine
      cpu: 14
      memory: 16gb
    - displayName: WholeMachine
      cpu: 28
      memory: 32gb

# Rates
- name: rates
  type: number
  default: 

    - 10
    - 100
    - 1000
    - 10000


# Scenarios
- name: scenarios 
  type: object
  default: 

  - displayName: Plaintext Middleware Docker
    arguments: --scenario plaintext $(containerMatrixJobs) --property scenario=Plaintext
  - displayName: Json Middleware Docker
    arguments: --scenario json $(containerMatrixJobs) --property scenario=Json
  - displayName: Fortunes Raw Middleware Docker
    arguments: --scenario db-fortunes $(containerMatrixJobs) --property scenario=Fortunes

steps:
- ${{ each scen in parameters.scenarios }}:
  - ${{ each size in parameters.sizes }}:
    - ${{ each rate in parameters.rates }}:
      - task: PublishToAzureServiceBus@1
        condition: succeededOrFailed()
        displayName: ${{ scen.displayName }} ${{ size.displayName }} ${{ rate }} RPS
        inputs:
          connectedServiceName: ${{ parameters.connection }}
          waitForCompletion: true
          messageBody: |
            {
              "name": "crank",
              "args": [ "--session $(session) ${{ scen.arguments }} --profile ${{ parameters.profile }} --property "cpu=${{ size.cpu }}" --property "mem=${{ size.mem }}" --property "rate=${{ rate }}" --property "duration=30" --variable cpu=${{ size.cpu }} --variable mem=${{ size.mem }} --variable rate=${{ rate }} --variable duration=30 --table ContainerBenchmarks --sql SQL_CONNECTION_STRING --chart" ]
            }